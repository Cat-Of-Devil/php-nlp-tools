<!Doctype html>
<html>

		<head>
		<base href="" >
		
		<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
		<meta charset="utf-8" />
		
					<title>Application outline | NlpTools PHP</title>
				<link rel="stylesheet" href="../style.css" />
		<script>
			var themeroller = (function () {
				var haveStyle = false,
					expired = 'Thu, 2 Aug 2001 20:47:11 UTC',
					unexpired = 'Mon, 2 Aug 2021 20:47:11 UTC',
					from = '',
					changeClasses = function (from,theme) {
						var items = document.getElementsByTagName('pre');
						for (var i=0;i<items.length;i++)
						{
							var cls_re = new RegExp('\\s?\\b'+from+'\\b\\s?|^\s*$');
							items[i].className = items[i].className.replace(cls_re,' '+theme+' ').trim();
						}
					},
					updateCookie = function (t) {
						if (t=='')
							document.cookie = 'theme=; expires='+expired+'; path=/';
						else
							document.cookie = 'theme='+t+'; expires='+unexpired+'; path=/';
						from = t;
					};
					
				return {
					onSelectChange: function () {
						var theme = this.options[this.selectedIndex].value;
						themeroller.changeHighlight(theme);
					},
					changeHighlight: function (theme) {
						
						if (haveStyle)
						{
							changeClasses(from,theme);
						}
						else
						{
							var l = document.createElement('link');
							l.rel = 'stylesheet';
							l.href = 'codecolorer.css';
							document.head.appendChild(l);
							haveStyle = true;
							changeClasses(from,theme);
						}
						updateCookie(theme);
					}
				}
			})();
		</script>
	</head>
	<body>
		<div class="header">
			<div class="container">
				<h1 class="title"><a href="../index.html">NlpTools</a></h1>
				<h2 class="subtitle">Natural language processing in php</h2>
				<b class="clear"></b>
			</div>
		</div>

		<div class="container">

			<div class="sidebar">
	
		<div class="sidebar-container">
		<h3>Navigation</h3>
					<a href="../index.html">Home</a><br/>
					<a href="../documentation/index.html">Documentation</a><br/>
					<a href="../blog/index.html">Blog</a><br/>
					<a href="https://github.com/angeloskath/php-nlp-tools/">Github</a><br/>
					<a href="mailto:info@php-nlp-tools.com">Contact</a><br/>
			</div>
		<div class="sidebar-container">
		<h3>Mini nlp projects</h3>
					<a href="../blog/category/spam-detection-service/index.html">Spam detection service</a><br/>
					<a href="../blog/category/sentiment-detection.1.html">Sentiment detection</a><br/>
					<a href="../blog/category/greek-pos-tagger.1.html">Greek POS Tagger</a><br/>
					<a href="../blog/category/programming-language-detection/index.html">Programming language detection</a><br/>
			</div>
		<div class="sidebar-container">
		<h3>Syntax highlighting</h3>
		<select id="theme-select" onchange="themeroller.onSelectChange.call(this)">
			<option value="">Vibrant Ink</option>
			<option value="twitlight">Twitlight</option>
			<option value="solarized-dark">Solarized Dark</option>
			<option value="dawn">Dawn</option>
			<option value="blackboard">Blackboard</option>
			<option value="mac-classic">Mac Classic</option>
			<option value="railscasts">Railscasts</option>
		</select>
		<p class="x-small">
			Style sheet provided by
			<a href="https://github.com/kpumuk/codecolorer">Codecolorer</a>
			and tokenizing by <a href="http://qbnz.com/highlighter/geshi-doc.html">GeSHi</a>
		</p>
	</div>
</div>
			
			<div class="content">
				<div class="post">
					<h2>
						Application outline													<span class="date">Mar 19th, 2013</span>
											</h2>
										<p class="meta">
						Project: <a href="../blog/category/spam-detection-service/index.html">Spam detection service</a>
					</p>
										<p>In the second post about this project, I will outline the silex
application and the input/output formats of the RESTful service.</p>

<h3>Input</h3>

<p>The email input format as it has been <a href="NB-incremental-training.html">previously</a>
mentioned will be in JSON. We will only be receiving the sender's email,
the subject and the body of the email. Each endpoint that receives emails
as input will be receiving many emails as an array.</p>

<pre><code>{
    "documents": [
        {
            "from": "example@example.com",
            "subject": "Test subject",
            "body": "Lorem ipsum dolor sit amet...",
            "class": "HAM"
        },
        {
            "from": "example@spam.com",
            "subject": "Cheap phones",
            "body": "Lorem ipsum dolor sit amet...",
            "class": "SPAM"
        },
        ...
        ...
        ...
    ]
}
</code></pre>

<p>If the emails are not for training but for classification, the class
attribute will be ignored.</p>

<h3>Output</h3>

<p>The app's response will always be in JSON too. We will be either outputing
an error message in the following form (with HTTP status 5xx or 4xx of
course)</p>

<pre><code>{
    "error": "This is a message"
}
</code></pre>

<p>or an array of labels with HTTP status 200</p>

<pre><code>["HAM","SPAM",....]
</code></pre>

<p>or an empty body with an informative HTTP status (like 204).</p>

<h3>Bootstraping</h3>

<p>Below follows the skeleton of our service's code. There are two functions
that train the models (train_new, retrain) and both return a model and a
training context (so that we can perform incremental training).</p>

<pre class="php"><ol><li class="li1"><div class="de1"><span class="kw1">require</span> __DIR__<span class="sy0">.</span><span class="st_h">'/../vendor/autoload.php'</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// Silex</span></div></li><li class="li1"><div class="de1"><span class="kw2">use</span> Symfony\Component\HttpFoundation\Request<span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="kw2">use</span> Symfony\Component\HttpFoundation\Response<span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// NlpTools</span></div></li><li class="li1"><div class="de1"><span class="kw2">use</span> NlpTools\Models\FeatureBasedNB<span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="kw2">use</span> NlpTools\Documents\TrainingSet<span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="kw2">use</span> NlpTools\FeatureFactories\DataAsFeatures<span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="kw2">use</span> NlpTools\Classifiers\MultinomialNBClassifier<span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="coMULTI">/*</span></div></li><li class="li1"><div class="de1"><span class="coMULTI"> * Train a model</span></div></li><li class="li1"><div class="de1"><span class="coMULTI"> * */</span></div></li><li class="li1"><div class="de1"> <span class="kw2">function</span> train_new<span class="br0">(</span>Request <span class="re0">$req</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"> <span class="br0">}</span></div></li><li class="li1"><div class="de1"> <span class="kw2">function</span> retrain<span class="br0">(</span>FeatureBasedNB <span class="re0">$model</span><span class="sy0">,</span><a href="http://www.php.net/array"><span class="kw3">array</span></a> <span class="sy0">&amp;</span><span class="re0">$ctx</span><span class="sy0">,</span> Request <span class="re0">$req</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"> <span class="br0">}</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// new App</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span> <span class="sy0">=</span> <span class="kw2">new</span> Silex\Application<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// a UID provider</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">register</span><span class="br0">(</span><span class="kw2">new</span> UIDServiceProvider<span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// a middleware to parse json requests to array</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">before</span><span class="br0">(</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span><a href="http://www.php.net/substr"><span class="kw3">substr</span></a><span class="br0">(</span><span class="re0">$req</span><span class="sy0">-&gt;</span><span class="me1">headers</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">(</span><span class="st_h">'Content-Type'</span><span class="br0">)</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">16</span><span class="br0">)</span> <span class="sy0">===</span> <span class="st_h">'application/json'</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="re0">$data</span> <span class="sy0">=</span> <a href="http://www.php.net/json_decode"><span class="kw3">json_decode</span></a><span class="br0">(</span><span class="re0">$req</span><span class="sy0">-&gt;</span><span class="me1">getContent</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">,</span><span class="kw4">true</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="re0">$req</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="sy0">-&gt;</span><span class="me1">replace</span><span class="br0">(</span><a href="http://www.php.net/is_array"><span class="kw3">is_array</span></a><span class="br0">(</span><span class="re0">$data</span><span class="br0">)</span> ? <span class="re0">$data</span> <span class="sy0">:</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// Create a new model</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">(</span><span class="st_h">'/models'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// Check if a model exists</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">(</span><span class="st_h">'/{uid}'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="sy0">,</span><span class="re0">$uid</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">-&gt;</span><a href="http://www.php.net/assert"><span class="kw3">assert</span></a><span class="br0">(</span><span class="st_h">'uid'</span><span class="sy0">,</span><span class="st_h">'[0-9a-f]+'</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// Delete an existing model</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">delete</span><span class="br0">(</span><span class="st_h">'/{uid}'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="sy0">,</span><span class="re0">$uid</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">-&gt;</span><a href="http://www.php.net/assert"><span class="kw3">assert</span></a><span class="br0">(</span><span class="st_h">'uid'</span><span class="sy0">,</span><span class="st_h">'[0-9a-f]+'</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// Report a number of emails as spam or not</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">(</span><span class="st_h">'/{uid}/report'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="sy0">,</span><span class="re0">$uid</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">-&gt;</span><a href="http://www.php.net/assert"><span class="kw3">assert</span></a><span class="br0">(</span><span class="st_h">'uid'</span><span class="sy0">,</span><span class="st_h">'[0-9a-f]+'</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="co1">// Classify a set of documents</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">(</span><span class="st_h">'/{uid}/classify'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="sy0">,</span><span class="re0">$uid</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="sy0">...</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">-&gt;</span><a href="http://www.php.net/assert"><span class="kw3">assert</span></a><span class="br0">(</span><span class="st_h">'uid'</span><span class="sy0">,</span><span class="st_h">'[0-9a-f]+'</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">run</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li></ol></pre>

<p>Let's take each endpoint in turns.</p>

<h3>POST /models</h3>

<p>Posting to <em>/models</em> creates a new model and trains it if emails are
provided. <em>$app['UID']</em> is a unique id provider. A folder is created
for the model and two files one representing the model and another the
training context. Both files contain Base64 encoded serialized php arrays
or objects.</p>

<pre class="php"><ol><li class="li1"><div class="de1"><span class="co1">// Create a new model</span></div></li><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">(</span><span class="st_h">'/models'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="re0">$uid</span> <span class="sy0">=</span> <span class="re0">$app</span><span class="br0">[</span><span class="st_h">'UID'</span><span class="br0">]</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span> <a href="http://www.php.net/file_exists"><span class="kw3">file_exists</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>"</span><span class="br0">)</span> <span class="br0">)</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span></div></li><li class="li1"><div class="de1">            <a href="http://www.php.net/array"><span class="kw3">array</span></a> <span class="br0">(</span></div></li><li class="li1"><div class="de1">                <span class="st0">"error"</span><span class="sy0">=&gt;</span><span class="st0">"Could not allocate a unique id for the new model"</span></div></li><li class="li1"><div class="de1">            <span class="br0">)</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">            <span class="nu0">500</span></div></li><li class="li1"><div class="de1">        <span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span> <span class="sy0">!</span><a href="http://www.php.net/mkdir"><span class="kw3">mkdir</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>"</span><span class="br0">)</span> <span class="br0">)</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span></div></li><li class="li1"><div class="de1">            <a href="http://www.php.net/array"><span class="kw3">array</span></a> <span class="br0">(</span></div></li><li class="li1"><div class="de1">                <span class="st0">"error"</span><span class="sy0">=&gt;</span><span class="st0">"Could not allocate a unique id for the new model"</span></div></li><li class="li1"><div class="de1">            <span class="br0">)</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">            <span class="nu0">500</span></div></li><li class="li1"><div class="de1">        <span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1">    <a href="http://www.php.net/list"><span class="kw3">list</span></a><span class="br0">(</span><span class="re0">$model</span><span class="sy0">,</span><span class="re0">$ctx</span><span class="br0">)</span> <span class="sy0">=</span> train_new<span class="br0">(</span><span class="re0">$req</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span><span class="re0">$ctx</span> <span class="sy0">!==</span> <span class="kw4">null</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/file_put_contents"><span class="kw3">file_put_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/ctx"</span><span class="sy0">,</span><a href="http://www.php.net/base64_encode"><span class="kw3">base64_encode</span></a><span class="br0">(</span><a href="http://www.php.net/serialize"><span class="kw3">serialize</span></a><span class="br0">(</span><span class="re0">$ctx</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <a href="http://www.php.net/file_put_contents"><span class="kw3">file_put_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/model"</span><span class="sy0">,</span><a href="http://www.php.net/base64_encode"><span class="kw3">base64_encode</span></a><span class="br0">(</span><a href="http://www.php.net/serialize"><span class="kw3">serialize</span></a><span class="br0">(</span><span class="re0">$model</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1">    <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span></div></li><li class="li1"><div class="de1">            <span class="st0">"id"</span> <span class="sy0">=&gt;</span> <span class="re0">$uid</span></div></li><li class="li1"><div class="de1">        <span class="br0">)</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">        <span class="nu0">201</span></div></li><li class="li1"><div class="de1">    <span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li></ol></pre>

<h3>GET /{uid}</h3>

<p>This endpoint simply returns 204 if the model was found or 404 if it
was not.</p>

<h3>DELETE /{uid}</h3>

<p>This edpoint simply deletes the model if it exists or returns a 404 error
otherwise.</p>

<h3>POST /{uid}/report</h3>

<p>This endpoint is used to further train the model. The model is unserialized
from the files and if a context exists is trained incrementally, otherwise
is trained from scratch.</p>

<pre class="php"><ol><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">(</span><span class="st_h">'/{uid}/report'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="sy0">,</span><span class="re0">$uid</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span><a href="http://www.php.net/file_exists"><span class="kw3">file_exists</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>"</span><span class="br0">)</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span></div></li><li class="li1"><div class="de1">            <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'error'</span><span class="sy0">=&gt;</span><span class="st_h">'Model not found'</span><span class="br0">)</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">            <span class="nu0">404</span></div></li><li class="li1"><div class="de1">        <span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span><a href="http://www.php.net/file_exists"><span class="kw3">file_exists</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/ctx"</span><span class="br0">)</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/list"><span class="kw3">list</span></a><span class="br0">(</span><span class="re0">$model</span><span class="sy0">,</span><span class="re0">$ctx</span><span class="br0">)</span> <span class="sy0">=</span> train_new<span class="br0">(</span><span class="re0">$req</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="kw1">if</span> <span class="br0">(</span><span class="re0">$ctx</span> <span class="sy0">===</span> <span class="kw4">null</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">            <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span><a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'error'</span><span class="sy0">=&gt;</span><span class="st_h">'No documents were reported'</span><span class="br0">)</span><span class="sy0">,</span><span class="nu0">400</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/file_put_contents"><span class="kw3">file_put_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/ctx"</span><span class="sy0">,</span><a href="http://www.php.net/base64_encode"><span class="kw3">base64_encode</span></a><span class="br0">(</span><a href="http://www.php.net/serialize"><span class="kw3">serialize</span></a><span class="br0">(</span><span class="re0">$ctx</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/file_put_contents"><span class="kw3">file_put_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/model"</span><span class="sy0">,</span><a href="http://www.php.net/base64_encode"><span class="kw3">base64_encode</span></a><span class="br0">(</span><a href="http://www.php.net/serialize"><span class="kw3">serialize</span></a><span class="br0">(</span><span class="re0">$model</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="kw1">else</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="re0">$ctx</span> <span class="sy0">=</span> <a href="http://www.php.net/unserialize"><span class="kw3">unserialize</span></a><span class="br0">(</span><a href="http://www.php.net/base64_decode"><span class="kw3">base64_decode</span></a><span class="br0">(</span><a href="http://www.php.net/file_get_contents"><span class="kw3">file_get_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/ctx"</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="re0">$model</span> <span class="sy0">=</span> <a href="http://www.php.net/unserialize"><span class="kw3">unserialize</span></a><span class="br0">(</span><a href="http://www.php.net/base64_decode"><span class="kw3">base64_decode</span></a><span class="br0">(</span><a href="http://www.php.net/file_get_contents"><span class="kw3">file_get_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/model"</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>retrain<span class="br0">(</span><span class="re0">$model</span><span class="sy0">,</span><span class="re0">$ctx</span><span class="sy0">,</span><span class="re0">$req</span><span class="br0">)</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">            <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span><a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'error'</span><span class="sy0">=&gt;</span><span class="st_h">'No documents were reported'</span><span class="br0">)</span><span class="sy0">,</span><span class="nu0">400</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/file_put_contents"><span class="kw3">file_put_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/ctx"</span><span class="sy0">,</span><a href="http://www.php.net/base64_encode"><span class="kw3">base64_encode</span></a><span class="br0">(</span><a href="http://www.php.net/serialize"><span class="kw3">serialize</span></a><span class="br0">(</span><span class="re0">$ctx</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <a href="http://www.php.net/file_put_contents"><span class="kw3">file_put_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/model"</span><span class="sy0">,</span><a href="http://www.php.net/base64_encode"><span class="kw3">base64_encode</span></a><span class="br0">(</span><a href="http://www.php.net/serialize"><span class="kw3">serialize</span></a><span class="br0">(</span><span class="re0">$model</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="kw1">return</span> <span class="kw2">new</span> Response<span class="br0">(</span><span class="st_h">''</span><span class="sy0">,</span><span class="nu0">204</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">-&gt;</span><a href="http://www.php.net/assert"><span class="kw3">assert</span></a><span class="br0">(</span><span class="st_h">'uid'</span><span class="sy0">,</span><span class="st_h">'[0-9a-f]+'</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li></ol></pre>

<h3>POST /{uid}/classify</h3>

<p>This endpoint actually uses the model to classify a set of documents
(emails). We will be talking about <strong>EmailFeatures, EmailDocument</strong> in
the next post.</p>

<pre class="php"><ol><li class="li1"><div class="de1"><span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">(</span><span class="st_h">'/{uid}/classify'</span><span class="sy0">,</span><span class="kw2">function</span> <span class="br0">(</span>Request <span class="re0">$req</span><span class="sy0">,</span><span class="re0">$uid</span><span class="br0">)</span> <span class="kw2">use</span><span class="br0">(</span><span class="re0">$app</span><span class="br0">)</span> <span class="br0">{</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span><a href="http://www.php.net/file_exists"><span class="kw3">file_exists</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>"</span><span class="br0">)</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span></div></li><li class="li1"><div class="de1">            <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'error'</span><span class="sy0">=&gt;</span><span class="st_h">'Model not found'</span><span class="br0">)</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">            <span class="nu0">404</span></div></li><li class="li1"><div class="de1">        <span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="re0">$response</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">    <span class="kw1">if</span> <span class="br0">(</span><span class="re0">$req</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="sy0">-&gt;</span><span class="me1">has</span><span class="br0">(</span><span class="st_h">'documents'</span><span class="br0">)</span> <span class="sy0">&amp;&amp;</span> <a href="http://www.php.net/is_array"><span class="kw3">is_array</span></a><span class="br0">(</span><span class="re0">$req</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">(</span><span class="st_h">'documents'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">    <span class="br0">{</span></div></li><li class="li1"><div class="de1">        <span class="co1">// create the feature factory</span></div></li><li class="li1"><div class="de1">        <span class="re0">$ff</span> <span class="sy0">=</span> <span class="kw2">new</span> EmailFeatures<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="co1">// get the model from the file</span></div></li><li class="li1"><div class="de1">        <span class="re0">$model</span> <span class="sy0">=</span> <a href="http://www.php.net/unserialize"><span class="kw3">unserialize</span></a><span class="br0">(</span><a href="http://www.php.net/base64_decode"><span class="kw3">base64_decode</span></a><span class="br0">(</span><a href="http://www.php.net/file_get_contents"><span class="kw3">file_get_contents</span></a><span class="br0">(</span><span class="st0">"models/<span class="es4">$uid</span>/model"</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="co1">// create a classifier</span></div></li><li class="li1"><div class="de1">        <span class="re0">$cls</span> <span class="sy0">=</span> <span class="kw2">new</span> MultinomialNBClassifier<span class="br0">(</span><span class="re0">$ff</span><span class="sy0">,</span><span class="re0">$model</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li><li class="li1"><div class="de1">        <span class="co1">// for each document</span></div></li><li class="li1"><div class="de1">        <span class="kw1">foreach</span> <span class="br0">(</span><span class="re0">$req</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">(</span><span class="st_h">'documents'</span><span class="br0">)</span> <span class="kw1">as</span> <span class="re0">$doc</span><span class="br0">)</span></div></li><li class="li1"><div class="de1">        <span class="br0">{</span></div></li><li class="li1"><div class="de1">            <span class="co1">// create an email document because that is what</span></div></li><li class="li1"><div class="de1">            <span class="co1">// EmailFeatures expects</span></div></li><li class="li1"><div class="de1">            <span class="re0">$email</span> <span class="sy0">=</span> <span class="kw2">new</span> EmailDocument<span class="br0">(</span></div></li><li class="li1"><div class="de1">                <span class="re0">$doc</span><span class="br0">[</span><span class="st_h">'from'</span><span class="br0">]</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">                <span class="re0">$doc</span><span class="br0">[</span><span class="st_h">'subject'</span><span class="br0">]</span><span class="sy0">,</span></div></li><li class="li1"><div class="de1">                <span class="re0">$doc</span><span class="br0">[</span><span class="st_h">'body'</span><span class="br0">]</span></div></li><li class="li1"><div class="de1">            <span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">            <span class="co1">// actually use the model to predict the class of this EmailDocument</span></div></li><li class="li1"><div class="de1">            <span class="re0">$response</span><span class="br0">[</span><span class="br0">]</span> <span class="sy0">=</span> <span class="re0">$cls</span><span class="sy0">-&gt;</span><span class="me1">classify</span><span class="br0">(</span><a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'SPAM'</span><span class="sy0">,</span><span class="st_h">'HAM'</span><span class="br0">)</span><span class="sy0">,</span><span class="re0">$email</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1">        <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="br0">}</span></div></li><li class="li1"><div class="de1">    <span class="co1">// show the predictions</span></div></li><li class="li1"><div class="de1">    <span class="kw1">return</span> <span class="re0">$app</span><span class="sy0">-&gt;</span><span class="me1">json</span><span class="br0">(</span><span class="re0">$response</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"><span class="br0">}</span><span class="br0">)</span><span class="sy0">-&gt;</span><a href="http://www.php.net/assert"><span class="kw3">assert</span></a><span class="br0">(</span><span class="st_h">'uid'</span><span class="sy0">,</span><span class="st_h">'[0-9a-f]+'</span><span class="br0">)</span><span class="sy0">;</span></div></li><li class="li1"><div class="de1"> </div></li></ol></pre>					<b class="clear"></b>
				</div>
			</div>

		</div>
		
		<div class="container" style="text-align: right;" id="footer">
	<p class="x-small">
		This website is powered by <a href="http://www.imdb.com/title/tt0198781/" title="I was thinking of putting 'cries of children' but it seemed too evil">the laughter of children</a>
	</p>
</div>
<div style="display: none;" id="geo-disclaimer">
	Αφού είσαι από <strong>Ελλάδα</strong> και σε ενδιαφέρει η επεξεργασία φυσικής γλώσσας, <a href="../greek-nlp.html">συνέχισε εδώ →</a>
</div>
<script>
	(function () {
		var co=document.cookie.split(';');
		for (var i=0;i<co.length;i++)
		{
			if (co[i].substr(0,6)!='theme=')
				continue;
			
			var newtheme = co[i].substr(6),
				theme_select = document.getElementById('theme-select'),
				opts = theme_select.options;
				
			themeroller.changeHighlight(newtheme);
			for (var j=0; j<opts.length; j++)
			{
				if (opts[j].value==newtheme)
				{
					theme_select.selectedIndex = j;
					break;
				}
			}
			break;
		}
	})();
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-9373187-5']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();

	// geoip
	(function () {
		var geo = document.createElement("script");
		geo.type = "text/javascript";
		geo.async = true;
		geo.src = "http://php-nlp-tools.com:8081/js";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(geo, s)
		geo.onload = function () {
			if (COUNTRY == "GR") {
				document.getElementById("footer").style.marginBottom = "60px";
				document.getElementById("geo-disclaimer").style.display = "block";
			}
		};
	})();
</script>
		
	</body>
</html>
